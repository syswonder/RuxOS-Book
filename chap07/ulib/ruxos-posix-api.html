<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ruxos-posix-api - RuxOS 手册</title>


        <!-- Custom HTML head -->

        <meta name="description" content="RuxOS 手册">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">RuxOS 手册</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/syswonder/ruxos" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ruxos-posix-api"><a class="header" href="#ruxos-posix-api">ruxos-posix-api</a></h1>
<p><code>ruxos-posix-api</code> 层提供了与 <a href="https://en.wikipedia.org/wiki/POSIX">POSIX</a> 标准一致的一批 API，用于支持 <a href="./ruxlibc.html">ruxlibc</a> 和 <a href="./ruxmusl.html">ruxmusl</a>。<code>ruxos-posix-api</code> 有以下特征：</p>
<ul>
<li>
<p>API 的设计和实现基于标准的 POSIX 标准。</p>
</li>
<li>
<p>API 使用 Rust 进行实现，同时提供具有相同名称的 Rust 和 C 的 API。</p>
</li>
<li>
<p>关注到 unikernel 操作系统的特点，部分 POSIX API 进行了特殊处理和实现。</p>
</li>
<li>
<p><code>ruxos-posix-api</code> 提供多模块的 Rust feature 来减小内核镜像大小。</p>
</li>
</ul>
<p>下面将对 <code>ruxos-posix-api</code> 的目的和与标准 POSIX API 的区别进行介绍和说明。</p>
<h2 id="目的"><a class="header" href="#目的">目的</a></h2>
<p>为了提供对用户库的支持，以及支持标准的 C 库，POSIX 定义了在不同系统上兼容的一批 API 的标准。</p>
<p><code>ruxos-posix-api</code> 基于 POSIX 规范对部分 POSIX 系统调用 API 进行了实现。系统调用号、参数类型、参数数量严格遵循 POSIX 系统调用标准，用来支持上层的 <code>ruxlibc</code> 和 <code>ruxmusl</code>。将用户库与系统调用层解耦，方便了系统开发人员定位错误和解决错误，具有更清晰的层次结构。</p>
<h2 id="区别"><a class="header" href="#区别">区别</a></h2>
<p><code>ruxos-posix-api</code> 与标准的 POSIX 系统调用 API 有以下的不同：</p>
<ul>
<li>
<p><a href="#%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%90%8D">系统调用名</a></p>
</li>
<li>
<p><a href="#%E6%9B%B4%E7%BB%86%E5%88%86%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8">更细分的系统调用</a></p>
</li>
<li>
<p><a href="#%E6%9E%B6%E6%9E%84%E6%97%A0%E5%85%B3">架构无关</a></p>
</li>
</ul>
<h3 id="系统调用名"><a class="header" href="#系统调用名">系统调用名</a></h3>
<p>系统调用以 <em>sys_</em> 开头，参考 <a href="#ruxos-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%88%97%E8%A1%A8">RuxOS 系统调用列表</a>，紧跟着是具体的函数名。</p>
<h3 id="更细分的系统调用"><a class="header" href="#更细分的系统调用">更细分的系统调用</a></h3>
<p>由于在 <a href="./ruxlibc.html">ruxlibc</a> 中对部分系统调用进行了特殊的对待和使用，而有的并不是在标准的 POSIX 库中，这部分 API 在 <a href="#ruxos-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%88%97%E8%A1%A8">RuxOS 系统调用列表</a> 用斜体指出，例如 <code>sys_pthread_create</code>。</p>
<p>通过加入更细化的系统调用，以及对一些特殊的库，例如 pthread 库，进行特殊处理，这一设计的目的在于缩短系统调用路径，以及省去某些 flag 参数解析时间。</p>
<p>由于在 unikernel 操作系统中，用户的应用程序和内核运行在同一特权级。因此，使用直接的函数调用，而非系统调用能够提高应用程序的性能，也减少了编程者和内核开发者的调试时间。</p>
<p>一些特殊处理的 API 在<a href="#%E7%89%B9%E6%AE%8Aapi">下面</a>进行了解释和介绍。</p>
<h3 id="架构无关"><a class="header" href="#架构无关">架构无关</a></h3>
<p>在标准的 POSXI 规范中，不同架构有不同的系统调用类型、名称，但在 <code>ruxos-posix-api</code> 中，我们不对架构进行区分，例如 AARCH64 上也同时存在 <code>dup/dup2/dup3</code> 三种 API。</p>
<h2 id="特殊api"><a class="header" href="#特殊api">特殊API</a></h2>
<p>由 RuxOS 自定义的 API 在<a href="#ruxos-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E5%88%97%E8%A1%A8">RuxOS 系统调用列表</a>用斜体标出。</p>
<p>下面对部分 API 进行说明和解释。</p>
<h3 id="sys_clone-vs-sys_pthread_create"><a class="header" href="#sys_clone-vs-sys_pthread_create">sys_clone VS sys_pthread_create</a></h3>
<p>在 libc 中，<code>sys_clone</code> 用于创建线程或进程。内核通过解析传入的标志来决定是否创建线程或进程，并设置新线程或新进程的共享属性。</p>
<p>在 unikernel 操作系统 RuxOS 中只支持一个进程，不支持 <code>fork</code> 功能。因此，RuxOS 的 <code>sys_clone</code> 语义只需要满足新线程的创建，新线程总是与父线程共享地址空间、文件描述符表、信号等资源。</p>
<p>通过简化语义，RuxOS 可以更快地完成线程创建，并保持与 Linux 基本一致的线程创建语义。 在 <a href="./ruxlibc.html">ruxlibc</a> 中，系统调用变成了函数调用，因此 RuxOS 不需要支持通过 <code>sys_clone</code> 创建新线程，而是直接支持 <code>pthread_create</code> 的实现，只是将新任务扔到调度队列中。</p>
<h3 id="sys_futex-vs-sys_mutex_xxx"><a class="header" href="#sys_futex-vs-sys_mutex_xxx">sys_futex VS sys_mutex_xxx</a></h3>
<p>在 Linux 内核中，futex 用于支持互斥锁等，通过监听某个地址的值来实现。</p>
<p>由于 RuxOS 内核提供了各种锁的实现，在支持 ruxlibc 时，RuxOS 实现了以 pthread_mutex 开头的互斥锁 API，可以直接调用内核中实现的互斥锁相关函数，并且兼容 musl libc 中的锁定义。</p>
<p>当支持 musl libc 时，RuxOS 实现了 futex 语义的简化版本。当线程监听的地址值不变时，会调用 <code>yield</code> 函数主动让出 CPU。</p>
<h3 id="sys_mmap"><a class="header" href="#sys_mmap">sys_mmap</a></h3>
<p>mmap 将一段虚拟地址映射给用户程序，并通过处理缺页异常为用户程序分配特定的物理地址。</p>
<p>在 RuxOS 中，由于用户程序只有一个进程，并且拥有整个物理地址空间，所以现在的 mmap 直接为用户程序分配给定大小的地址空间，并在 munmap 中释放。同时，RuxOS不支持文件映射，因此不处理 fd。</p>
<h3 id="sys_pthread_key_xxx"><a class="header" href="#sys_pthread_key_xxx">sys_pthread_key_xxx</a></h3>
<p><code>pthread_key</code> 相关的 API 提供线程局部键值对存储。这部分的实现本应该属于 libc 。</p>
<p>但为了更简单直接地支持这些 API，RuxOS 将相应的键值放入 <code>task_inner</code> 结构中，简化了 ruxlibc 的实现。</p>
<p>在 musl libc 中，这部分被放置到 musl libc 管理的 tls 中，因此 RuxOS 不需要提供相应的系统调用。</p>
<h3 id="sys_freeaddrinfo-sys_getaddrinfo"><a class="header" href="#sys_freeaddrinfo-sys_getaddrinfo">sys_freeaddrinfo, sys_getaddrinfo</a></h3>
<p>libc 中的这两个 API 解析网络地址以及释放相应的数据结构。它的实现属于 libc 层，由于需要读取本地的 <code>/etc/hosts</code> 文件来发送 DNS 查询，RuxOS 对其进行了特殊处理以简化实现。</p>
<h2 id="ruxos-系统调用列表"><a class="header" href="#ruxos-系统调用列表">RuxOS 系统调用列表</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Module Name</th><th>Syscall Name</th><th>Description</th></tr></thead><tbody>
<tr><td><strong>io_mpx</strong></td><td>sys_epoll_create</td><td>Create an epoll fd</td></tr>
<tr><td></td><td>sys_epoll_ctl</td><td>Control interface for an epoll file descriptor</td></tr>
<tr><td></td><td>sys_epoll_pwait, sys_epoll_wait</td><td>Wait for an I/O event on an epoll file descriptor</td></tr>
<tr><td></td><td>sys_poll, sys_ppoll</td><td>Wait for some event on a file descriptor</td></tr>
<tr><td></td><td>sys_pselect6, sys_select</td><td>Monitor multiple file descriptors</td></tr>
<tr><td><strong>io</strong></td><td>sys_read, sys_write</td><td>Read/Write from a fd</td></tr>
<tr><td></td><td>sys_readv, sys_writev</td><td>Read/Write data from/into multiple buffers</td></tr>
<tr><td><strong>resources</strong></td><td>sys_getrlimit, sys_prlimit64, sys_setrlimit</td><td>Get/Set resource limits</td></tr>
<tr><td><strong>rt_sig</strong></td><td>sys_rt_sigaction</td><td>Examine and change a signal action</td></tr>
<tr><td></td><td>sys_rt_sigprocmask</td><td>Examine and change blocked signals</td></tr>
<tr><td><strong>stat</strong></td><td>sys_umask</td><td>Set file mode creation mask</td></tr>
<tr><td><strong>sys</strong></td><td>sys_sysinfo</td><td>Return system information</td></tr>
<tr><td><strong>task</strong></td><td>sys_exit</td><td></td></tr>
<tr><td></td><td>sys_getpid</td><td></td></tr>
<tr><td></td><td>sys_sched_yield</td><td></td></tr>
<tr><td><strong>time</strong></td><td>sys_clock_gettime, sys_clock_settime</td><td></td></tr>
<tr><td></td><td>sys_nanosleep</td><td></td></tr>
<tr><td><strong>fd_ops</strong></td><td>sys_close</td><td></td></tr>
<tr><td></td><td>sys_dup, sys_dup2, sys_dup3</td><td></td></tr>
<tr><td></td><td>sys_fcntl</td><td></td></tr>
<tr><td><strong>fs</strong></td><td>sys_fdatasync, sys_fsync</td><td></td></tr>
<tr><td></td><td>sys_fstat, sys_lstat, sys_newfstatat, sys_stat</td><td></td></tr>
<tr><td></td><td>sys_getcwd</td><td></td></tr>
<tr><td></td><td>sys_open, sys_openat</td><td></td></tr>
<tr><td></td><td>sys_mkdir, sys_mkdirat</td><td></td></tr>
<tr><td></td><td>sys_rename, sys_renameat</td><td></td></tr>
<tr><td></td><td>sys_unlink, sys_unlinkat</td><td></td></tr>
<tr><td></td><td>sys_lseek</td><td></td></tr>
<tr><td></td><td>sys_rmdir</td><td></td></tr>
<tr><td><strong>ioctl</strong></td><td>sys_ioctl</td><td></td></tr>
<tr><td><strong>mmap</strong></td><td>sys_mmap, sys_munmap</td><td></td></tr>
<tr><td></td><td>sys_mprotect</td><td></td></tr>
<tr><td><strong>net</strong></td><td>sys_accept, sys_bind, sys_connect, sys_listen</td><td></td></tr>
<tr><td></td><td>sys_socket</td><td></td></tr>
<tr><td></td><td>sys_shutdown</td><td></td></tr>
<tr><td></td><td><em>sys_freeaddrinfo, sys_getaddrinfo</em></td><td></td></tr>
<tr><td></td><td>sys_recv, sys_recvfrom</td><td></td></tr>
<tr><td></td><td>sys_send, sys_sendmsg, sys_sendto</td><td></td></tr>
<tr><td></td><td>sys_getsockname</td><td></td></tr>
<tr><td></td><td>sys_setsockopt</td><td></td></tr>
<tr><td></td><td>sys_getpeername</td><td></td></tr>
<tr><td><strong>pipe</strong></td><td>sys_pipe, sys_pipe2</td><td></td></tr>
<tr><td><strong>signal</strong></td><td>sys_getitimer, sys_setitimer</td><td></td></tr>
<tr><td></td><td>sys_sigaction</td><td></td></tr>
<tr><td><strong>pthread</strong></td><td><em>sys_pthread_getspecific/setspecific</em></td><td></td></tr>
<tr><td></td><td><em>sys_pthread_key_create/delete</em></td><td></td></tr>
<tr><td></td><td><em>sys_pthread_create, sys_pthread_exit</em></td><td></td></tr>
<tr><td></td><td><em>sys_pthread_join</em></td><td></td></tr>
<tr><td></td><td><em>sys_pthread_self</em></td><td></td></tr>
<tr><td></td><td>sys_clone</td><td></td></tr>
<tr><td></td><td>sys_set_tid_address</td><td></td></tr>
<tr><td><strong>pthread::futex</strong></td><td>sys_futex</td><td></td></tr>
<tr><td><strong>pthread::condvar</strong></td><td><em>sys_pthread_cond_timedwait, sys_pthread_cond_wait</em></td><td></td></tr>
<tr><td></td><td><em>sys_pthread_cond_init/destroy</em></td><td></td></tr>
<tr><td></td><td><em>sys_pthread_cond_signal/broadcast</em></td><td></td></tr>
<tr><td><strong>pthread::mutex</strong></td><td><em>sys_pthread_mutex_destroy/init</em></td><td></td></tr>
<tr><td></td><td><em>sys_pthread_mutex_lock/trylock/unlock</em></td><td></td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../chap07/ulib/ulib.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../chap07/ulib/ruxlibc.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../chap07/ulib/ulib.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../chap07/ulib/ruxlibc.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../assets/fzf.umd.js"></script>
        <script src="../../assets/elasticlunr.js"></script>


    </div>
    </body>
</html>
