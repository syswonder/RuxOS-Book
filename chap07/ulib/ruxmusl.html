<!DOCTYPE HTML>
<html lang="zh" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>ruxmusl - RuxOS 手册</title>


        <!-- Custom HTML head -->

        <meta name="description" content="RuxOS 手册">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">RuxOS 手册</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/syswonder/ruxos" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ruxmusl"><a class="header" href="#ruxmusl">ruxmusl</a></h1>
<p>本章节主要介绍了将 <a href="https://www.musl-libc.org/">musl libc</a> 集成到 RuxOS 的过程。RuxOS 使用了一层兼容层来适配 musl libc，最终通过了 <a href="https://git.musl-libc.org/cgit/libc-bench/">libc-bench</a> 的测试。</p>
<h2 id="从-musl-libc-到系统调用层"><a class="header" href="#从-musl-libc-到系统调用层">从 musl libc 到系统调用层</a></h2>
<h3 id="引入-musl-libc-的重要性"><a class="header" href="#引入-musl-libc-的重要性">引入 musl libc 的重要性</a></h3>
<p><code>musl libc</code> 提供了 C 应用程序所必须的诸多 API，并且对内核的系统调用进行了封装。但是，并不是所有的函数都需要用到系统调用，有一大批的例如字符串处理等函数，不需要系统调用。这一批函数在 <code>musl libc</code> 中提供了相对完整、高效，且久经考验的实现。</p>
<p>因此，将 <code>musl libc</code> 集成到 RuxOS 之后，包含字符串处理在内的众多函数，内核将不再做额外的实现。在与 musl libc 并列的 <a href="./ruxlibc.html">ruxlibc</a> 中，需要对这些函数进行一一实现，引入了较为繁琐的工作量，且容易出现错误。</p>
<h3 id="系统调用及系统调用号"><a class="header" href="#系统调用及系统调用号">系统调用及系统调用号</a></h3>
<p>系统调用是由内核定义的一批可移植 API，根据不同的体系结构，系统调用对应的系统调用号可能不同。在 AARCH64 中，可以通过 <code>path/to/musl-libc/arch/aarch64/bits/syscall.h.in</code> 文件来查看。</p>
<p>对比不同架构上的系统调用，我们能够发现不只是系统调用号不一致，系统调用的类型也存在差别。例如，AARCH64 提供了 <code>dup</code> 和 <code>dup3</code> 两个系统调用，而没有提供 <code>dup2</code>，其中 <code>dup2</code> 是借助 <code>dup</code> + <code>fcntl</code> 来进行实现的。而 x86_64 则提供了上述三种系统调用。</p>
<h3 id="触发同步异常"><a class="header" href="#触发同步异常">触发同步异常</a></h3>
<p>如何从 libc 函数进入到内核的系统调用层？以 <code>read()</code> 函数为例：</p>
<ul>
<li>
<p><code>read()</code> 是由 C 标准库提供的读函数，实现在 <code>path/to/musl-libc/src/unistd/read.c</code>。在该函数中，调用 <code>syscall_cp(SYS_read, fd, buf, count)</code>，里面存在一个宏，定义在 <code>path/to/musl/arch/aarch64/syscall_arch.h</code> 中，通过 <code>svc 0</code> 来完成系统调用。并且将相关参数存到 <code>x0~x5</code>，将系统调用号存到了 <code>x8</code>，也就是说系统调用最多支持6个参数。</p>
</li>
<li>
<p><code>svc 0</code> 会触发一个同步异常，该同步异常迫使内核跳转到异常向量表中，查找并跳转到由内核定义的同步异常处理函数。</p>
</li>
</ul>
<h2 id="系统调用处理a64"><a class="header" href="#系统调用处理a64">系统调用处理（A64）</a></h2>
<h3 id="解析参数"><a class="header" href="#解析参数">解析参数</a></h3>
<p>同步异常会进入到 <code>modules/ruxhal/src/arch/aarch64/trap.rs</code> 中定义的 <code>handle_sync_exception()</code> 函数，在这里通过解析 <code>ESR</code> 寄存器来获取异常状态信息，即发生异常的原因。然后通过读取 <code>x0~x5</code> 和 <code>x8</code> 来获取系统调用的参数和系统调用号，并进入到系统调用处理函数。</p>
<p>当开启 <code>musl</code> 这个 feature 时，在 <code>modules/ruxhal/src/trap.rs</code> 中的 <code>TrapHandler</code> trait 会增加 <code>handle_syscall()</code> 这个方法，具体实现在 <code>ulib/ruxmusl/src/trap.rs</code>。在这里会解析系统调用号，并分发到具体的处理函数。</p>
<h3 id="系统调用分发"><a class="header" href="#系统调用分发">系统调用分发</a></h3>
<p>分发过程在 <code>ulib/ruxmusl/src/syscall/mod.rs</code> 中，系统调用号与标准的 A64 系统调用号一致，定义在 <code>ulib/ruxmusl/src/syscall/syscall_id.rs</code> 中，但目前存在部分系统调用缺失，后续会进行补全。分发过程即是匹配系统调用号的过程，并根据系统调用号将传入的参数解析为不同的类型，然后调用在 <a href="./ruxos-posix-api.html"><code>ruxos-posix-api</code></a> 中实现的具体的系统调用。</p>
<h2 id="使用-ruxmusl"><a class="header" href="#使用-ruxmusl">使用 ruxmusl</a></h2>
<p>RuxOS 已经通过 makefile 给用户提供了简便的使用 musl libc 的方法，在编译、运行 C 程序的时候，只需要加上 <code>MUSL=y</code> 即可。</p>
<p>在使用 musl libc 的时候，有部分 feature 是需要强制定义的，RuxOS 已将其集成到了 makefile 中，无需额外工作：</p>
<ul>
<li>
<p><strong>fp_simd</strong>: 由于 musl libc 需要编译所有的 C 标准库函数，包含了 <code>double</code> 等浮点数类型，因此需要开启该 feature。</p>
</li>
<li>
<p><strong>fd</strong>: 由于 musl libc 需要初始化 stdin/stdout/stderr，因此需要默认开启该 feature。</p>
</li>
<li>
<p><strong>tls</strong>: musl libc 自己对 tls 进行了管理，在创建新线程的时候，通过 <code>mmap</code> 预留了一部分用于存储 tls 的空间，但是需要将这部分空间的起始地址存储到指定的寄存器中，后续才能通过 <code>pthread_self()</code> 获取 tls 数据，因此需要开启该 feature。</p>
</li>
</ul>
<p>RuxOS 会主动的拉取并编译 musl libc 的源码，用户目前只能针对 <code>ARCH=aarch64</code> 使用 musl libc，因为目前仅对 A64 进行了系统调用号的匹配。</p>
<p>编译、链接过程与 ruxlibc 类似，在使用 ruxlibc 的时候，会在 <code>target/</code> 目录下生成一个 <code>.a</code> 文件，而 musl libc 会在 musl 目录的 <code>install/</code> 生成 <code>libc.a</code> 文件，使用该文件进行链接即可（无需应用额外做该工作，已集成到 makefile 中）。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../chap07/ulib/ruxlibc.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../Contributors.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../chap07/ulib/ruxlibc.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../Contributors.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../assets/fzf.umd.js"></script>
        <script src="../../assets/elasticlunr.js"></script>


    </div>
    </body>
</html>
